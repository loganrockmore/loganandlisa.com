<html>
	<head>
		<title>Vanlife Plans</title>
		<meta name="viewport" content="width=device-width, user-scalable=no" />
		<link rel="apple-touch-icon" href="apple-touch-icon.png?modified=1" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		
		<script>
			
			const events = [
                {
                    title: 'Condo Furniture',
                    startDate: date(2019, 04, 09),
                    endDate: date(2019, 04, 09),
                    location: 'San Francisco, CA',
                },
                {
                    title: 'Flight Out',
                    startDate: date(2019, 04, 17),
                    endDate: date(2019, 04, 17),
                    location: 'San Francisco, CA',
                    logistical: true,
                },
                {
                    title: 'IPO Party',
                    startDate: date(2019, 04, 18),
                    endDate: date(2019, 04, 20),
                    location: 'New York City, NY',
					flyIn: true,
					flyOut: true,
                },
                {
                    title: 'Flight Back',
                    startDate: date(2019, 04, 21),
                    endDate: date(2019, 04, 21),
                    location: 'San Francisco, CA',
                    logistical: true,
                },
                {
                    title: 'San Juan Boat Trip',
                    startDate: date(2019, 05, 10),
                    endDate: date(2019, 05, 19),
                    location: 'Seattle, WA',
                },
                {
                    title: 'Mikey and Martha\'s Wedding Shower',
                    startDate: date(2019, 05, 26),
                    endDate: date(2019, 05, 26),
                    location: 'Milwaukee, WI',
                },
                {
                    title: 'Weitekamp Family Reunion',
                    startDate: date(2019, 05, 31),
                    endDate: date(2019, 06, 02),
                    location: 'Farmersville, IL',
                },
                {
                    title: 'Lonely Island Concert',
                    startDate: date(2019, 06, 19),
                    endDate: date(2019, 06, 19),
                    location: 'Philadelphia, PA',
                },
                {
                    title: 'Julie and Kevin\'s Wedding',
                    startDate: date(2019, 06, 20),
                    endDate: date(2019, 06, 23),
                    location: 'Cooksburg, PA',
                },
                {
                    title: 'Flight Out',
                    startDate: date(2019, 07, 03),
                    endDate: date(2019, 07, 03),
                    location: 'Pittsburgh, PA',
                    logistical: true,
                },
                {
                    title: 'Birthday Weekend',
                    startDate: date(2019, 07, 04),
                    endDate: date(2019, 07, 07),
                    location: 'Seattle, WA',
					flyIn: true,
					flyOut: true,
                },
                {
                    title: 'Flight Back',
                    startDate: date(2019, 07, 08),
                    endDate: date(2019, 07, 08),
                    location: 'Pittsburgh, PA',
                    logistical: true,
                },
                {
                    title: 'BRASA Build Time',
                    startDate: date(2019, 07, 14),
                    endDate: date(2019, 07, 28),
                    location: 'Seattle, WA',
                },
                {
                    title: 'Last day to leave Seattle',
                    startDate: date(2019, 08, 01),
                    endDate: date(2019, 08, 01),
                    location: 'Seattle, WA',
                    logistical: true,
                },
                {
                    title: 'Reno',
                    startDate: date(2019, 08, 03),
                    endDate: date(2019, 08, 03),
                    location: 'Reno, NV',
                    logistical: true,
                },
                {
                    title: 'Mikey and Martha\'s Wedding!',
                    startDate: date(2019, 08, 13),
                    endDate: date(2019, 08, 19),
                    location: 'Milwaukee, WI',
                },
                {
                    title: 'Reno',
                    startDate: date(2019, 08, 22),
                    endDate: date(2019, 08, 22),
                    location: 'Reno, NV',
                    logistical: true,
                },
                {
                    title: 'Burning Man',
                    startDate: date(2019, 08, 23),
                    endDate: date(2019, 09, 03),
                    location: 'Gerlach, NV',
                },
                {
                    title: 'Alison and Robert\'s Wedding!',
                    startDate: date(2019, 09, 13),
                    endDate: date(2019, 09, 15),
                    location: 'New York, NY',
                },
                {
                    title: 'Flight Out',
                    startDate: date(2019, 09, 25),
                    endDate: date(2019, 09, 25),
                    location: 'New York, NY',
                    logistical: true,
                },
                {
                    title: 'Oktoberfest!!!',
                    startDate: date(2019, 09, 26),
                    endDate: date(2019, 09, 27),
                    location: 'Munich, Germany',
					flyIn: true,
					flyOut: true,
                },
                {
                    title: 'Flight Back',
                    startDate: date(2019, 09, 28),
                    endDate: date(2019, 09, 28),
                    location: 'New York, NY',
                    logistical: true,
                },
                {
                    title: 'Rachel and Jake\'s Wedding!',
                    startDate: date(2019, 10, 17),
                    endDate: date(2019, 10, 19),
                    location: 'Destin, FL',
                },
			];
			
			function date(year, month, day) {
				return new Date(year, month-1, day);
			}
			
		</script>
		
		<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<script src="lodash.min.js"></script>
		<script src="jquery.min.js"></script>
		<script src="jquery-datepicker.min.js"></script>
		<script src="moment.min.js"></script>
		<script src="turf.min.js"></script>
		
		<style>
			
			body {
				margin: 0px;
				padding: 0px;
				font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
			   font-weight: 300;
			}
			
			@font-face {
				font-family: 'Beyno';
				src: url('beyno.otf')  format('truetype');
			}
			
			body.wakanda {
				font-family: "Beyno";
				text-transform: uppercase;
			}
			
			div#map,
			div#calendar {
				top: 0;
				bottom: 0;
			}
			
			div#map {
				position: fixed;
				left: 0;
				width: 70%;
			}
			
			div#calendar {
				position: absolute;
				width: 30%;
				right: 0;
				padding: 0 1em;
				box-sizing: border-box;
			}
			
			@media only screen and (max-width: 500px) {
				
				div#map {
					position: fixed;
					top: 0;
					left: 0;
					right: 0;
					width: auto;
					height: 40%;
					z-index: 1;
				}
				
				div#calendar {
					position: relative;
					width: auto;
					top: 40%;
					padding: 0 1em;
				}
			}
			
			div#calendar table {
				border-collapse: collapse;
				border-spacing: 0;
			}
			
			div#calendar tr.disabled {
				opacity: 0.15;
			}
			
			div#calendar tr td.left {
				text-align: right;
				padding-right: 1em;
			}
			
			div#calendar tr td.right {
				cursor: hand;
			}
			
			div#calendar tr td.line {
				border-left-width: 1px;
				border-left-color: black;
				padding-right: 1em;
			}
			
			div#calendar tr.event td.line {
				height: 1px; /* hack to get the div the right size */
			}
			
			div#calendar tr.event td.line div {
				background-color: black;
				margin-left: -5px;
				width: 9px;
				border-radius: 4.5px;
				height: 100%;
			}
			
			div#calendar tr.event.logistical td.line div {
				background-color: #888;
			}
			
			div#calendar tr td.line.driving {
				border-left-style: dashed;
			}
			
			div#calendar tr td.line.flying {
				border-left-style: solid;
			}
			
			div#calendar tr.event td {
				vertical-align: top;
			}
			
			div#calendar tr.event td.left,
			div#calendar tr.event td.right {
				padding-top: 0.5em;
				padding-bottom: 0.5em;
			}
			
			div#calendar tr.event.logistical td {
				color: #888;
			}
			
			div#calendar tr.event.logistical.highlighted td div {
				color: black;
			}
			
			div#calendar tr.event td.left div.day {
				width: 4em;
				font-weight: 600;
			}
			
			div#calendar tr.event td.left div.day div.dayTo {
				font-weight: 100;
				font-size: 0.8em;
			}
			
			div#calendar tr.event td.right div.title {
				margin-bottom: 0.1em;
			}
			
			div#calendar tr.event td.right div.location {
				font-size: 0.7em;
			}
			
			div#calendar tr.travel td.left div,
			div#calendar tr.travel td.right div {
				color: #888;
				font-size: 0.8em;
			}
			
			div#calendar tr.travel.highlighted td.left div,
			div#calendar tr.travel.highlighted td.right div {
				color: black;
			}
			
			div#map div.marker {
				width: 10px;
				height: 10px;
				border-radius: 5px;
				background-color: #990000;
			}
			
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div id="calendar">
			<table>
			</table>
		</div>
		
		<script>
			
			if (-1 !== location.search.indexOf("wakanda")) {
				$("body").addClass("wakanda");
			}
			
			function addEventTableViewRow(day, title, location, index, logistical) {
				const dayView = $("<div>", {"class": "day"});
				dayView.html(day);
				
				const titleView = $("<div>", {"class": "title"});
				titleView.text(title);
				
				const locationView = $("<div>", {"class": "location"});
				locationView.text(location);
				
				addTableViewRow("event", [dayView], [titleView, locationView], undefined, undefined, logistical, index);
			}
			
			function addTravelTableViewRow(daysInBetween, modeOfTransportation, index) {
				const daysInBetweenSuffix = (daysInBetween === 1) ? 'day' : 'days';
				
				const daysInBetweenView = $("<div>", {
					"class": "daysInBetween",
					"id": "daysInBetween-" + index,
				});
				daysInBetweenView.text(daysInBetween + ' ' + daysInBetweenSuffix);
				
				const distanceView = $("<div>", {
					"class": "distance",
					"id": "distance-" + index
				});
				
				const distancePerDayView = $("<div>", {
					"class": "distancePerDay",
					"id": "distancePerDay-" + index
				});
				
				const rowHeight = Math.max(daysInBetween * 7, 75);
				
				addTableViewRow("travel", [daysInBetweenView], [distanceView, distancePerDayView], rowHeight, modeOfTransportation, false, index);
			}
			
			function addTableViewRow(elementType, leftElement, rightElement, customRowHeight, modeOfTransportation, logistical, index) {
				
				const classes = [elementType];
				if (logistical) {
					classes.push("logistical");
				}
				
				const tableRow = $("<tr>", {
					"class": classes.join(" "),
					"id": elementType + index,
				});
				$("#calendar > table").append(tableRow);
				
				const leftCell = $("<td>", {"class": "left"});
				leftCell.append(leftElement);
				tableRow.append(leftCell);
				
				const lineCell = $("<td>", {"class": "line"});
				if (modeOfTransportation) {
					lineCell.addClass(modeOfTransportation);
				}
				tableRow.append(lineCell);
				
				if (customRowHeight) {
					lineCell.css('height', customRowHeight);
				}
				
				if (elementType === "event") {
					const lineEvent = $("<div>");
					lineCell.append(lineEvent);
				}
				
				const rightCell = $("<td>", {
					"class": "right",
					"onmouseover": elementType + "OnMouseOver(" + index + ")",
					"onmouseout": "onHoverMouseOut()",
				});
				rightCell.append(rightElement);
				tableRow.append(rightCell);
			}
			
			
			// sort the events
			const sortedAllEvents = _.sortBy(events, (event) => {
				return event.startDate;
			});
			
			// remove any events in the past
			const todayDate = new Date();
			const todayDateMoment = moment(todayDate);
			const sortedEvents = _.filter(sortedAllEvents, (event) => {
				const eventMoment = moment(event.startDate);
				return eventMoment.diff(todayDateMoment) > 0;
			});
			
			
			// add top row to add some spacing to the timeline
			const topTableRow = $("<tr>");
			$("#calendar > table").append(topTableRow);
				
			topTableRow.append($("<td>"));
			topTableRow.append($("<td>", {"class": "line flying",}).css('height', '4em'));
			
			// add an event row for today
			const formattedDay = $.datepicker.formatDate('M d', todayDate);
			addEventTableViewRow(formattedDay, 'Today', undefined, -1, false);
			
			// add a travel row for today
			const firstEventMoment = moment(sortedEvents[0].startDate);
			const daysInBetween = firstEventMoment.diff(todayDateMoment, "days");
			addTravelTableViewRow(daysInBetween+1, "flying", -1);
			
			// add calendar item for each event
			_.each(sortedEvents, (event, index) => {
				
				// fancy format the date
				const formattedStartDay = $.datepicker.formatDate('M d', event.startDate);
				const formattedEndDay = $.datepicker.formatDate('M d', event.endDate);
				
				let day;
				if (formattedStartDay === formattedEndDay) {
					day = formattedStartDay;
					
				} else {
					day = formattedStartDay + '<div class="dayTo">to</div>' + formattedEndDay;
				}
				
				// add event row
				addEventTableViewRow(day, event.title, event.location, index, event.logistical);
				
				// add travel row
				const nextEvent = sortedEvents[index+1];
				if (nextEvent) {
					
					const eventMoment = moment(event.endDate);
					const nextEventMoment = moment(nextEvent.startDate);
					const daysInBetween = nextEventMoment.diff(eventMoment, "days");
					
					const isFlying = _.get(nextEvent, 'flyIn', false) || _.get(event, 'flyOut', false);
					const modeOfTransportation = isFlying ? "flying" : "driving";
					
					addTravelTableViewRow(daysInBetween, modeOfTransportation, index);
				}
			});
			
			// add bottom row to add some spacing to the timeline
			const bottomTableRow = $("<tr>");
			$("#calendar > table").append(bottomTableRow);
				
			bottomTableRow.append($("<td>"));
			bottomTableRow.append($("<td>", {"class": "line flying"}).css('height', '4em'));
			
			// create the map
			mapboxgl.accessToken = 'pk.eyJ1IjoibG9nYW5yb2NrbW9yZSIsImEiOiJjamR0N2Nmc2EwODlsMnhsMzhhZjdqc2hxIn0.2b8odx5yDsbWAgYpGjJysw';
			const map = new mapboxgl.Map({
			    container: 'map',
			    style: 'mapbox://styles/mapbox/light-v9'
			});
				
			let latLongs;
			let allMarkersBounds;
			
			if (navigator.userAgent.indexOf("Coda") === -1) {
				
				// plot each location on the map
				const locationRequests = _.map(sortedEvents, (event) => {
					const searchTerm = encodeURIComponent(event.location + ', United States');
					return $.ajax('https://api.mapbox.com/geocoding/v5/mapbox.places/' + searchTerm + '.json?access_token=' + mapboxgl.accessToken);
				});
				
				$.when.apply(undefined, locationRequests).then(function() {
					const responses = arguments;
					
					latLongs = _.map(sortedEvents, (event, index) => {
						const location = event.location;
						const searchResults = responses[index];
						const bestSearchResult = searchResults[0].features[0];
						return bestSearchResult.center;
					});
					
					allMarkersBounds = new mapboxgl.LngLatBounds();
					
					_.each(latLongs, (latLong, index) => {
						const lastLatLong = latLongs[index-1];
							
						// extend the bounds
						allMarkersBounds.extend(latLong);
						
					    map.addLayer({
					        "id": "location-" + index,
					        "type": "symbol",
					        "source": {
					            "type": "geojson",
					            "data": {
					                "type": "FeatureCollection",
					                "features": [{
					                    "type": "Feature",
					                    "geometry": {
					                        "type": "Point",
									        "coordinates": latLong,
					                    }
					                }]
					            }
					        },
					        "layout": {
					            "icon-image": "circle-15",
					        }
					    });
					});
					
					// fit the map to these lat longs
					map.fitBounds(allMarkersBounds, {
						padding: 50,
					});
					
					// function for adding driving layers
					function addLayersToMap(index, geometry, dashArray) {
					
						map.addLayer({
							id: "route-" + (index+1),
							type: "line",
							source: {
								type: "geojson",
								data: {
									type: "Feature",
									geometry: geometry
								},
							},
							"layout": {
							    "line-join": "round",
							    "line-cap": "round"
							},
							"paint": {
							    "line-color": "#111111",
							    "line-width": 2,
							    "line-dasharray": dashArray
							}
					    });
						
						map.addLayer({
							id: "route-green-" + (index+1),
							type: "line",
							source: {
								type: "geojson",
								data: {
									type: "Feature",
									geometry: geometry
								},
							},
							"layout": {
							    "line-join": "round",
							    "line-cap": "round",
							    "visibility": "none"
							},
							"paint": {
							    "line-color": "#2ECC40",
							    "line-width": 2,
							    "line-dasharray": dashArray
							}
					    });
						
						map.addLayer({
							id: "route-red-" + (index+1),
							type: "line",
							source: {
								type: "geojson",
								data: {
									type: "Feature",
									geometry: geometry
								},
							},
							"layout": {
							    "line-join": "round",
							    "line-cap": "round",
							    "visibility": "none"
							},
							"paint": {
							    "line-color": "#FF4136",
							    "line-width": 2,
							    "line-dasharray": dashArray
							}
					    });
					}
				
					// add driving route lines
					const drivingRouteRequests = {};
					const flyingRouteIndexes = {};
					_.each(latLongs, (latLong, index) => {
						const lastLatLong = latLongs[index-1];
						
						if (!lastLatLong) {
							return null;
						}
						
						// this is a flying route
						const event = sortedEvents[index-1];
						const nextEvent = sortedEvents[index];
						const isFlyingRoute = _.get(nextEvent, 'flyIn', false) || _.get(event, 'flyOut', false);
						
						if (isFlyingRoute) {
							flyingRouteIndexes[index] = [[lastLatLong[0], lastLatLong[1]], [latLong[0], latLong[1]]];
						} else {
							drivingRouteRequests[index] = $.ajax('https://api.mapbox.com/directions/v5/mapbox/driving/' + lastLatLong[0] + ',' + lastLatLong[1] + ';' + latLong[0] + ',' + latLong[1] + '?geometries=geojson&access_token=' + mapboxgl.accessToken);
						}
					});
					
					const ajaxRequests = $.map(drivingRouteRequests, function(value, key) { return value; });
					
					$.when.apply(undefined, ajaxRequests).then(function() {
						const responses = arguments;
						
						_.each(responses, (response, responseIndex) => {
							
							const request = response[2];
							let index;
							_.each(drivingRouteRequests, (thisRequest, thisIndex) => {
								if (request == thisRequest) {
									index = thisIndex-1;
								}
							});
							
							// get the geometry
							const route = response[0].routes[0];
							const geometry = route.geometry;
							const dashArray = [2, 4];
							
							// add distances to the timeline
							const distanceMeters = route.distance;
							const distanceMiles = distanceMeters * 0.000621371192;
							const formattedDistance = distanceMiles.toFixed(0);
							$("#distance-" + index).text('drive ' + formattedDistance + ' miles');
							
							let days = parseInt($("#daysInBetween-" + index).text());
							if (days === 0) {
								days = 1;
							}
							const milesPerDay = distanceMiles/days;
							const formattedDistancePerDay = milesPerDay.toFixed(0);
							$("#distancePerDay-" + index).text('average ' + formattedDistancePerDay + ' miles per day');
							
							addLayersToMap(index, geometry, dashArray);
						});
					});
				
					// add flying routes
					_.each(flyingRouteIndexes, (coordinates, index) => {
						
						const firstCoordinate = _.first(coordinates);
						const lastCoordinate = _.last(coordinates);
						
						// calculate the geometry points for the arc
						const lineDistance = turf.distance(turf.point(firstCoordinate), turf.point(lastCoordinate), {units: 'kilometers'});
						
						const straightLineFeature = {
					        "type": "Feature",
					        "geometry": {
					            "type": "LineString",
					            "coordinates": [
					                firstCoordinate,
					                lastCoordinate
					            ]
					        }
					    };
						const arcPoints = [];
						
						for (var i = 0; i < lineDistance; i++) {
							var segment = turf.along(straightLineFeature, i / 1000 * lineDistance, {units: 'kilometers'});
							arcPoints.push(segment.geometry.coordinates);
						}
						
						geometry = {
							type: "LineString",
							coordinates: arcPoints,
						};
						dashArray = [1, 0];
						
						addLayersToMap(index-1, geometry, dashArray);
						
						// add distances to the timeline
						const distanceKilometers = getDistanceFromLatLonInKm(firstCoordinate[0], firstCoordinate[1], lastCoordinate[0], lastCoordinate[1]);
						const distanceMiles = distanceKilometers * 0.621371192;
						const formattedDistance = distanceMiles.toFixed(0);
						$("#distance-" + (index-1)).text('fly ' + formattedDistance + ' miles');
					});
				});
				
				
				function eventOnMouseOver(index) {
					if (-1 === index) {
						return;
					}
					
					// update styling of the list
					$("div#calendar table tr").addClass("disabled");
					$("div#calendar table tr#event" + index).removeClass("disabled").addClass("highlighted");
					
					// update visibility of map elements
					for(let i = 0; i < sortedEvents.length; i++) {
						if (i !== index) {
							map.setLayoutProperty('location-' + i, 'visibility', 'none');
						}
						if (i > 0) {
							map.setLayoutProperty('route-' + i, 'visibility', 'none');
						}
						if (i > 0 && i === index) {
							map.setLayoutProperty('route-green-' + i, 'visibility', 'visible');
						}
						if (i > 0 && i === index+1) {
							map.setLayoutProperty('route-red-' + i, 'visibility', 'visible');
						}
					}
					
					// update the bounds of the map
					const bounds = new mapboxgl.LngLatBounds();
					bounds.extend(latLongs[index]);
					map.fitBounds(bounds, {
						padding: 50,
						maxZoom: 9
					});
				}
				
				function travelOnMouseOver(index) {
					if (-1 === index) {
						return;
					}
					
					// update styling of the list
					$("div#calendar table tr").addClass("disabled");
					$("div#calendar table tr#travel" + index).removeClass("disabled").addClass("highlighted");
					
					// update visibility of map elements
					for(let i = 0; i < sortedEvents.length; i++) {
						if (i !== index && i !== index+1) {
							map.setLayoutProperty('location-' + i, 'visibility', 'none');
						}
						if (i > 0 && i !== index+1) {
							map.setLayoutProperty('route-' + i, 'visibility', 'none');
						}
					}
					
					// update the bounds of the map
					const bounds = new mapboxgl.LngLatBounds();
					bounds.extend(latLongs[index]);
					bounds.extend(latLongs[index+1]);
					map.fitBounds(bounds, {
						padding: 50,
						maxZoom: 7
					});
				}
				
				function onHoverMouseOut() {
					// update styling of the list
					$("div#calendar table tr").removeClass("disabled").removeClass("highlighted");
					
					// update visibility of map elements
					for(let i = 0; i < sortedEvents.length; i++) {
						map.setLayoutProperty('location-' + i, 'visibility', 'visible');
						if (i > 0) {
							map.setLayoutProperty('route-' + i, 'visibility', 'visible');
							map.setLayoutProperty('route-green-' + i, 'visibility', 'none');
							map.setLayoutProperty('route-red-' + i, 'visibility', 'none');
						}
					}
					
					// update the bounds of the map
					map.fitBounds(allMarkersBounds, {
						padding: 50,
					});
				}
				
				
				// from https://stackoverflow.com/questions/27928/calculate-distance-between-two-latitude-longitude-points-haversine-formula
				function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
				  var R = 6371; // Radius of the earth in km
				  var dLat = deg2rad(lat2-lat1);  // deg2rad below
				  var dLon = deg2rad(lon2-lon1); 
				  var a = 
				    Math.sin(dLat/2) * Math.sin(dLat/2) +
				    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
				    Math.sin(dLon/2) * Math.sin(dLon/2)
				    ; 
				  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
				  var d = R * c; // Distance in km
				  return d;
				}
				
				function deg2rad(deg) {
				  return deg * (Math.PI/180)
				}
			}
			
		</script>
	</body>
</html>